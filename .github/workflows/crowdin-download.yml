name: Crowdin Download Translations

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

# Prevent multiple workflow runs executing at the same time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  download:
    environment: "prod"
    name: Synchronize with Crowdin
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      UPDATE_BRANCH: ci/update-locale
      BASE_BRANCH: master
    steps:
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Change branch to the update branch
        id: branches
        run: |
          git pull
          echo "base=$(git rev-parse origin/${{ env.BASE_BRANCH }})" >> $GITHUB_OUTPUT
          if git rev-parse --quiet --verify origin/${{ env.UPDATE_BRANCH }}; then
            git checkout ${{ env.UPDATE_BRANCH }}
            echo "update=$(git rev-parse ${{ env.UPDATE_BRANCH }}~)" >> $GITHUB_OUTPUT
            echo "Branch ${{ env.UPDATE_BRANCH }} exists, checking out"
          else
            git checkout -b ${{ env.UPDATE_BRANCH }}
            echo "Created and checked out new branch ${{ env.UPDATE_BRANCH }}"
          fi

      - name: Use the base branch instead
        if: ${{ steps.branches.outputs.base != steps.branches.outputs.update }}
        run: |
          git checkout ${{ env.BASE_BRANCH }}
          echo "Using base branch instead of update branch"

      - name: Delete Steam package.json
        run: rm -f packages/steam/package.json

      - name: Install Dependencies
        run: |
          bun install
          bun add -g i18next-parser

      - name: Download Crowdin Translations
        uses: crowdin/github-action@v2
        with:
          download_translations: true
          upload_sources: false
          upload_translations: false
          create_pull_request: false
          push_translations: false
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

      - name: Organize translations
        run: |
          sudo chown -R $(id -u):$(id -g) packages/**/locales/* || echo "No locale files to change ownership for"
          i18next -c 'services/crowdin/src/i18next-parser.config.js'

      - name: Check for changes
        id: changes
        run: |
          git add packages/**/locales/* || echo "No locale files to add"
          CHANGES=$(git status --porcelain | wc -l)
          echo "lines=$CHANGES" >> $GITHUB_OUTPUT
          if [ "$CHANGES" != "0" ]; then
            echo "Found $CHANGES changed files"
          else
            echo "No translation changes detected"
          fi

      - name: Create Pull Request
        if: ${{ steps.changes.outputs.lines != '0' }}
        uses: peter-evans/create-pull-request@v7.0.8
        with:
          title: "[CI] New Crowdin Translations"
          body: |
            ## Crowdin Translation Update

            This PR contains the latest approved translations from Crowdin.

            *Automatically created by the Crowdin Download workflow.*
          base: ${{ env.BASE_BRANCH }}
          branch: ${{ env.UPDATE_BRANCH }}
          commit-message: ðŸ’… i18n update from crowdin
          delete-branch: true
          add-paths: |
            packages/**/locales/*
